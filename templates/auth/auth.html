{% include 'head_template.html' %}

<body>
    {% include 'header.html' %}

    {% load crispy_forms_tags %}

    <div class="container my-5 py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-5">
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden">

                    <!-- Card Header with Orange Gradient -->
                    <div class="card-header text-white text-center py-4"
                        style="background: linear-gradient(135deg, #ff6600 0%, #ff9f4d 100%);">
                        <h2 class="fw-bold mb-2">
                            <i class="fas fa-mobile-alt me-2"></i>Welcome Back
                        </h2>
                        <p class="mb-0 opacity-75">Sign in to continue shopping</p>
                    </div>

                    <div class="card-body p-4 p-md-5">

                        <!-- Progress Steps -->
                        <div class="d-flex justify-content-between align-items-center mb-5 position-relative">
                            <div class="position-absolute top-50 start-0 end-0 translate-middle-y"
                                style="height: 2px; background: #dee2e6; z-index: 0;"></div>

                            <div class="text-center flex-fill position-relative" style="z-index: 1;" id="step1">
                                <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                    style="width: 45px; height: 45px; background: #ff6600; color: white;">
                                    <strong>1</strong>
                                </div>
                                <small class="fw-semibold" style="color: #ff6600;">Mobile</small>
                            </div>

                            <div class="text-center flex-fill position-relative" style="z-index: 1;" id="step2">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-2"
                                    style="width: 45px; height: 45px; color: #6c757d;">
                                    <strong>2</strong>
                                </div>
                                <small class="text-muted">OTP</small>
                            </div>

                            <div class="text-center flex-fill position-relative" style="z-index: 1;" id="step3">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-2"
                                    style="width: 45px; height: 45px; color: #6c757d;">
                                    <strong>3</strong>
                                </div>
                                <small class="text-muted">Verify</small>
                            </div>
                        </div>

                        <!-- Social Login Section -->
                        <!-- Social Login Section (Updated - Works Like Real Google/Facebook Login) -->
                        <div class="mb-4">
                            <p class="text-center text-muted mb-3 fw-semibold">Quick Sign In</p>
                            <div class="row g-3">

                                <!-- GOOGLE LOGIN - DIRECT ACCOUNT SELECT (NO MIDDLE PAGE) -->
                                <div class="col-6">
                                    <a href="/accounts/google/login/?process=login&prompt=select_account"
                                        class="btn btn-outline-danger w-100 py-2 d-flex align-items-center justify-content-center gap-2 rounded-3">
                                        <i class="fab fa-google fs-5"></i>
                                        <span class="d-none d-sm-inline fw-semibold">Google</span>
                                    </a>
                                </div>

                                <!-- FACEBOOK LOGIN -->
                                <div class="col-6">
                                    <a href="/accounts/facebook/login/?process=login&prompt=select_account"
                                        class="btn btn-outline-primary w-100 py-2 d-flex align-items-center justify-content-center gap-2 rounded-3">
                                        <i class="fab fa-facebook-f fs-5"></i>
                                        <span class="d-none d-sm-inline fw-semibold">Facebook</span>
                                    </a>
                                </div>

                            </div>
                        </div>


                        <!-- Divider -->
                        <div class="position-relative text-center my-4">
                            <hr class="my-0">
                            <span
                                class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted small">
                                or use mobile number
                            </span>
                        </div>

                        <!-- Mobile Number Step -->
                        <div id="mobile-step">
                            <form method="POST" action="{% url 'shop:send-otp' %}" id="mobile-form">
                                {% csrf_token %}

                                <div class="mb-4">
                                    <label for="id_mobile" class="form-label fw-semibold">
                                        <i class="fas fa-phone me-2" style="color: #ff6600;"></i>Mobile Number
                                    </label>
                                    {{ mobile_form.mobile }}
                                    {% if mobile_form.mobile.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ mobile_form.mobile.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <button type="submit" class="btn w-100 py-3 fw-semibold rounded-3 shadow-sm"
                                    style="background: #ff6600; color: white; border: none;">
                                    <i class="fas fa-paper-plane me-2"></i>Send OTP
                                </button>
                            </form>

                            <div class="text-center mt-4">
                                <small class="text-muted">
                                    Don't have an account?
                                    <a href="{% url 'shop:auth-page' %}" class="text-decoration-none fw-semibold"
                                        style="color: #ff6600;">
                                        Sign Up
                                    </a>
                                </small>
                            </div>
                        </div>

                        <!-- OTP Verification Step -->
                        <div id="otp-step" class="d-none">

                            <!-- Success Alert -->
                            <div class="alert alert-success border-0 rounded-3 d-flex align-items-start mb-4"
                                role="alert">
                                <i class="fas fa-check-circle me-3 mt-1" style="font-size: 1.5rem;"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">OTP Sent Successfully!</h6>
                                    <p class="mb-0 small">We've sent a 6-digit code to
                                        <strong id="phone-display" style="color: #ff6600;"></strong>
                                    </p>
                                </div>
                            </div>

                            <h5 class="text-center mb-4 fw-bold">Enter Verification Code</h5>

                            <form method="POST" action="{% url 'shop:verify-otp' %}" id="otp-form">
                                {% csrf_token %}

                                <div class="mb-4">
                                    <label for="id_otp" class="form-label fw-semibold">
                                        <i class="fas fa-lock me-2" style="color: #ff6600;"></i>OTP Code
                                    </label>
                                    {{ otp_form.otp }}
                                    {% if otp_form.otp.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ otp_form.otp.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Timer -->
                                <div class="text-center mb-4">
                                    <div class="badge rounded-pill px-4 py-2"
                                        style="background: #fff8f0; color: #ff6600; font-size: 0.9rem;">
                                        <i class="fas fa-clock me-2"></i>
                                        <span id="time-remaining" class="fw-bold">03:00</span>
                                    </div>
                                </div>

                                <button type="submit" class="btn w-100 py-3 fw-semibold rounded-3 shadow-sm mb-3"
                                    style="background: #ff6600; color: white; border: none;">
                                    <i class="fas fa-shield-alt me-2"></i>Verify OTP
                                </button>

                                <button type="button" class="btn btn-outline-secondary w-100 py-2 rounded-3"
                                    id="resend-otp" disabled>
                                    <i class="fas fa-redo me-2"></i>Resend OTP
                                </button>
                            </form>

                            <div class="text-center mt-4">
                                <a href="#" id="change-number" class="text-decoration-none fw-semibold"
                                    style="color: #ff6600;">
                                    <i class="fas fa-edit me-2"></i>Change Mobile Number
                                </a>
                            </div>
                        </div>

                    </div>

                    <!-- Card Footer -->
                    <div class="card-footer bg-light text-center py-3 border-0">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1" style="color: #ff6600;"></i>
                            Your information is secure with us
                        </small>
                    </div>

                </div>

                <!-- Additional Help -->
                <div class="text-center mt-4">
                    <small class="text-muted">
                        Need help? <a href="{% url 'shop:contact' %}" class="text-decoration-none"
                            style="color: #ff6600;">Contact Support</a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script>
        let timerInterval;
        let timeLeft = 180;

        // Mobile form submission
        document.getElementById('mobile-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const phoneNumber = document.querySelector('input[name="mobile"]').value;

            // Switch views
            document.getElementById('mobile-step').classList.add('d-none');
            document.getElementById('otp-step').classList.remove('d-none');

            // Update step 1 - completed
            const step1Circle = document.querySelector('#step1 .rounded-circle');
            const step1Text = document.querySelector('#step1 small');
            step1Circle.style.background = '#28a745';
            step1Circle.style.color = 'white';
            step1Text.style.color = '#28a745';
            step1Text.textContent = 'Done';

            // Update step 2 - active
            const step2Circle = document.querySelector('#step2 .rounded-circle');
            const step2Text = document.querySelector('#step2 small');
            step2Circle.style.background = '#ff6600';
            step2Circle.style.color = 'white';
            step2Text.style.color = '#ff6600';
            step2Text.classList.remove('text-muted');
            step2Text.classList.add('fw-semibold');

            // Update step 3 - pending
            const step3Circle = document.querySelector('#step3 .rounded-circle');
            const step3Text = document.querySelector('#step3 small');
            step3Circle.style.background = '#ff9f4d';
            step3Circle.style.color = 'white';
            step3Text.style.color = '#ff9f4d';

            // Display phone number
            document.getElementById('phone-display').textContent = phoneNumber;

            // Start timer
            startTimer();

            // Submit form via AJAX
            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.message || 'Failed to send OTP. Please try again.');
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        // Change number handler
        document.getElementById('change-number').addEventListener('click', function (e) {
            e.preventDefault();

            document.getElementById('otp-step').classList.add('d-none');
            document.getElementById('mobile-step').classList.remove('d-none');

            // Reset steps
            const step1Circle = document.querySelector('#step1 .rounded-circle');
            const step1Text = document.querySelector('#step1 small');
            step1Circle.style.background = '#ff6600';
            step1Circle.style.color = 'white';
            step1Text.style.color = '#ff6600';
            step1Text.textContent = 'Mobile';

            const step2Circle = document.querySelector('#step2 .rounded-circle');
            const step2Text = document.querySelector('#step2 small');
            step2Circle.style.background = '#f8f9fa';
            step2Circle.style.color = '#6c757d';
            step2Text.style.color = '#6c757d';
            step2Text.classList.add('text-muted');
            step2Text.classList.remove('fw-semibold');

            const step3Circle = document.querySelector('#step3 .rounded-circle');
            const step3Text = document.querySelector('#step3 small');
            step3Circle.style.background = '#f8f9fa';
            step3Circle.style.color = '#6c757d';
            step3Text.style.color = '#6c757d';

            clearInterval(timerInterval);
            timeLeft = 180;
        });

        // Timer function
        function startTimer() {
            const resendBtn = document.getElementById('resend-otp');
            const timerDisplay = document.getElementById('time-remaining');
            resendBtn.disabled = true;

            timerInterval = setInterval(function () {
                timeLeft--;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;

                timerDisplay.textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'Expired';
                    timerDisplay.parentElement.style.background = '#ffe8e8';
                    timerDisplay.parentElement.style.color = '#dc3545';
                    resendBtn.disabled = false;
                    resendBtn.classList.remove('btn-outline-secondary');
                    resendBtn.classList.add('btn-outline-danger');
                }
            }, 1000);
        }

        // Resend OTP handler
        document.getElementById('resend-otp').addEventListener('click', function () {
            const phoneNumber = document.getElementById('phone-display').textContent;

            fetch("{% url 'shop:send-otp' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `mobile=${phoneNumber}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        timeLeft = 180;
                        const timerDisplay = document.getElementById('time-remaining');
                        timerDisplay.parentElement.style.background = '#fff8f0';
                        timerDisplay.parentElement.style.color = '#ff6600';
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-outline-secondary');
                        startTimer();

                        // Show success message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.innerHTML = '<i class="fas fa-check-circle me-2"></i>OTP resent successfully!';
                        document.querySelector('#otp-step form').prepend(alert);
                        setTimeout(() => alert.remove(), 3000);
                    }
                });
        });
    </script>

</body>

</html>