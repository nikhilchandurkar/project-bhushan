{% load crispy_forms_tags %}
<!DOCTYPE html>
<html>
<head>
    <title>Login - OTP Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        .stage {
            display: none;
        }
        .stage.active {
            display: block;
        }
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #e9ecef;
            position: relative;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step:not(:last-child)::after {
            content: '→';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }
        .alert {
            margin-top: 15px;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow p-4 mx-auto" style="max-width: 500px;">
        <h3 class="text-center mb-4">Login with OTP</h3>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" id="step-1">
                <strong>1.</strong> Mobile Number
            </div>
            <div class="step" id="step-2">
                <strong>2.</strong> Receive OTP
            </div>
            <div class="step" id="step-3">
                <strong>3.</strong> Verify
            </div>
        </div>

        <!-- Stage 1: Enter Mobile Number -->
        <div id="stage-1" class="stage active">
            <form id="mobile-form">
                {% csrf_token %}
                {{ mobile_form|crispy }}

                <button class="btn btn-primary w-100 mt-3" type="submit">
                    <span class="btn-text">Send OTP</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </form>
        </div>

        <!-- Stage 2: OTP Sent Confirmation -->
        <div id="stage-2" class="stage">
            <div class="alert alert-success text-center">
                <strong>✓ OTP Sent Successfully!</strong>
                <p class="mb-0 mt-2">We've sent a 6-digit OTP to <strong id="mobile-display"></strong></p>
            </div>

            <button id="proceed-btn" class="btn btn-success w-100 mt-3">
                Enter OTP Code
            </button>

            <button id="change-mobile-btn" class="btn btn-outline-secondary w-100 mt-2">
                Change Mobile Number
            </button>
        </div>

        <!-- Stage 3: Enter OTP -->
        <div id="stage-3" class="stage">
            <form id="otp-form">
                {% csrf_token %}
                {{ otp_form|crispy }}

                <div class="text-center mb-3">
                    <p class="text-muted mb-1">Time remaining</p>
                    <h4 id="timer" class="text-primary">03:00</h4>
                </div>

                <button class="btn btn-success w-100 mt-2" type="submit">
                    <span class="btn-text">Verify OTP</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>

                <button id="resend-btn" type="button" class="btn btn-outline-primary w-100 mt-2" disabled>
                    Resend OTP
                </button>
            </form>
        </div>

        <!-- Error/Success Messages -->
        <div id="message-container"></div>
    </div>
</div>

<script>
console.log("=== OTP Verification System Initialized ===");

let MOBILE = "";
let timerInterval = null;
let currentStage = 1;

// Utility: Show Message
function showMessage(message, type = 'danger') {
    console.log(`[MESSAGE] Type: ${type}, Message: ${message}`);
    
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const html = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $("#message-container").html(html);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        $(".alert").fadeOut(() => $(this).remove());
    }, 5000);
}

// Utility: Show Loading
function setLoading(formId, isLoading) {
    const $form = $(`#${formId}`);
    const $btn = $form.find('button[type="submit"]');
    
    if (isLoading) {
        console.log(`[LOADING] Form: ${formId} - Loading started`);
        $btn.prop('disabled', true);
        $btn.find('.btn-text').addClass('d-none');
        $btn.find('.spinner-border').removeClass('d-none');
    } else {
        console.log(`[LOADING] Form: ${formId} - Loading ended`);
        $btn.prop('disabled', false);
        $btn.find('.btn-text').removeClass('d-none');
        $btn.find('.spinner-border').addClass('d-none');
    }
}

// Utility: Change Stage
function goToStage(stage) {
    console.log(`[STAGE CHANGE] Moving from Stage ${currentStage} to Stage ${stage}`);
    
    $(".stage").removeClass("active");
    $(`#stage-${stage}`).addClass("active");
    
    $(".step").removeClass("active completed");
    for (let i = 1; i < stage; i++) {
        $(`#step-${i}`).addClass("completed");
    }
    $(`#step-${stage}`).addClass("active");
    
    currentStage = stage;
    $("#message-container").html("");
}

// Timer Function
function startTimer() {
    console.log("[TIMER] Starting 3-minute countdown");
    
    let seconds = 180; // 3 minutes
    $("#resend-btn").prop("disabled", true);

    timerInterval = setInterval(() => {
        let m = String(Math.floor(seconds / 60)).padStart(2, '0');
        let s = String(seconds % 60).padStart(2, '0');
        $("#timer").text(`${m}:${s}`);

        if (seconds <= 0) {
            console.log("[TIMER] Countdown finished - Resend button enabled");
            clearInterval(timerInterval);
            $("#resend-btn").prop("disabled", false);
            showMessage("OTP expired. Please request a new one.", "danger");
        }
        seconds--;
    }, 1000);
}

// CSRF Token Setup
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// STAGE 1: Send OTP
$("#mobile-form").on("submit", function (e) {
    e.preventDefault();
    console.log("=== STAGE 1: Send OTP ===");
    
    const mobile = $("input[name=mobile]").val();
    console.log(`[INPUT] Mobile Number: ${mobile}`);
    
    setLoading('mobile-form', true);

    $.ajax({
        url: "/auth/send-otp/",
        type: "POST",
        data: { mobile: mobile },
        success: function (res) {
            console.log("[SUCCESS] OTP sent successfully");
            console.log("[RESPONSE]", res);
            
            MOBILE = res.mobile || mobile;
            $("#mobile-display").text(MOBILE);
            
            setLoading('mobile-form', false);
            goToStage(2);
        },
        error: function (xhr) {
            console.error("[ERROR] Failed to send OTP");
            console.error("[ERROR DETAILS]", xhr.responseJSON);
            
            setLoading('mobile-form', false);
            
            const errorMsg = xhr.responseJSON?.error || 
                           xhr.responseJSON?.mobile?.[0] || 
                           "Failed to send OTP. Please try again.";
            showMessage(errorMsg, 'danger');
        }
    });
});

// STAGE 2: Proceed to OTP Entry
$("#proceed-btn").on("click", function () {
    console.log("=== STAGE 2: Proceeding to OTP Entry ===");
    goToStage(3);
    startTimer();
});

// STAGE 2: Change Mobile Number
$("#change-mobile-btn").on("click", function () {
    console.log("=== STAGE 2: Returning to Mobile Entry ===");
    goToStage(1);
    $("input[name=mobile]").val("");
});

// STAGE 3: Verify OTP
$("#otp-form").on("submit", function (e) {
    e.preventDefault();
    console.log("=== STAGE 3: Verify OTP ===");
    
    const otp = $("input[name=otp]").val();
    console.log(`[INPUT] OTP Code: ${otp}`);
    console.log(`[INPUT] Mobile: ${MOBILE}`);
    
    setLoading('otp-form', true);

    $.ajax({
        url: "/auth/verify-otp/",
        type: "POST",
        data: {
            mobile: MOBILE,
            otp: otp
        },
        success: function (res) {
            console.log("[SUCCESS] OTP verified successfully");
            console.log("[RESPONSE]", res);
            console.log("[TOKENS] Access:", res.access);
            console.log("[TOKENS] Refresh:", res.refresh);
            
            clearInterval(timerInterval);
            setLoading('otp-form', false);
            
            showMessage("✓ Login successful! Redirecting...", "success");
            
            // Store tokens
            const inMemoryStorage = {};
            inMemoryStorage.access = res.access;
            inMemoryStorage.refresh = res.refresh;
            console.log("[STORAGE] Tokens stored in memory (localStorage not supported)");
            
            setTimeout(() => {
                console.log("[REDIRECT] Navigating to home page");
                window.location.href = "/";
            }, 1500);
        },
        error: function (xhr) {
            console.error("[ERROR] OTP verification failed");
            console.error("[ERROR DETAILS]", xhr.responseJSON);
            
            setLoading('otp-form', false);
            
            const errorMsg = xhr.responseJSON?.error || 
                           xhr.responseJSON?.otp?.[0] || 
                           "Invalid OTP. Please try again.";
            showMessage(errorMsg, 'danger');
        }
    });
});

// STAGE 3: Resend OTP
$("#resend-btn").on("click", function () {
    console.log("=== STAGE 3: Resending OTP ===");
    console.log(`[INPUT] Mobile: ${MOBILE}`);
    
    $("#resend-btn").prop("disabled", true);

    $.ajax({
        url: "/auth/send-otp/",
        type: "POST",
        data: { mobile: MOBILE },
        success: function(res) {
            console.log("[SUCCESS] OTP resent successfully");
            console.log("[RESPONSE]", res);
            
            showMessage("New OTP sent successfully!", "success");
            clearInterval(timerInterval);
            startTimer();
        },
        error: function(xhr) {
            console.error("[ERROR] Failed to resend OTP");
            console.error("[ERROR DETAILS]", xhr.responseJSON);
            
            showMessage("Failed to resend OTP. Please try again.", "danger");
            $("#resend-btn").prop("disabled", false);
        }
    });
});

console.log("=== Script Loaded Successfully ===");
</script>

</body>
</html>